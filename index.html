<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Cadastro de Colaboradores ‚Äì Pagamento via Pix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --bg-page:#f5f7fa;
      --bg-card:#ffffff;
      --bg-card-alt:#f2f4f8;
      --border-subtle:#e0e4ec;
      --border-strong:#c7cfdd;
      --shadow-soft:0 10px 30px rgba(15,23,42,0.06);
      --text-main:#1f2933;
      --text-muted:#7b8794;
      --text-strong:#102a43;
      --accent:#1f7acb;
      --accent-soft:#e3f1ff;
      --accent-strong:#145a9e;
      --danger:#d7263d;
      --radius-lg:0.75rem;
      --radius-full:999px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#e8f1ff 0,#f5f7fa 42%,#e5e7eb 100%);
      color:var(--text-main);
    }
    .page-shell{
      max-width:1240px;
      margin:0 auto;
      padding:1.5rem 1.25rem 2.5rem;
    }
    header.page-header{
      text-align:center;
      margin-bottom:1.75rem;
    }
    .page-title{
      font-size:clamp(1.4rem,2.4vw + 1rem,2rem);
      font-weight:700;
      letter-spacing:0.03em;
      color:var(--text-strong);
      margin-bottom:0.25rem;
    }
    .page-subtitle{
      font-size:0.85rem;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.16em;
    }
    main{display:grid;gap:1.25rem;}
    .card{
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(147,161,183,0.35);
      padding:1.25rem 1.2rem 1.2rem;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top right,rgba(31,122,203,0.08),transparent 55%);
      opacity:0.9;
      pointer-events:none;
    }
    .card-inner{position:relative;z-index:1;}
    .card-header{
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem 1rem;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:0.9rem;
    }
    .card-title{
      font-size:1rem;
      font-weight:600;
      color:var(--text-strong);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .card-title-span{
      padding:0.15rem 0.6rem;
      border-radius:999px;
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      background:rgba(31,122,203,0.06);
      color:var(--accent-strong);
      border:1px solid rgba(31,122,203,0.45);
    }
    .card-subtitle{font-size:0.75rem;color:var(--text-muted);}
    .form-section{
      margin-bottom:0.8rem;
      padding:0.65rem 0.75rem 0.7rem;
      border-radius:0.6rem;
      background:var(--bg-card-alt);
      border:1px solid var(--border-subtle);
    }
    .form-section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:0.35rem;
    }
    .form-section-title{
      font-size:0.8rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-muted);
    }
    .form-section-caption{font-size:0.7rem;color:#9ca3af;}
    .form-grid{display:grid;gap:0.65rem 0.75rem;}
    @media (min-width:720px){
      .form-grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr));}
      .form-grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    .field{display:flex;flex-direction:column;gap:0.22rem;}
    .field label{
      font-size:0.78rem;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.35rem;
      flex-wrap:wrap;
    }
    .field label span.required{font-size:0.7rem;color:var(--danger);}
    .field input,
    .field select,
    .field textarea{
      font-family:inherit;
      font-size:0.8rem;
      padding:0.35rem 0.45rem;
      border-radius:0.4rem;
      border:1px solid var(--border-strong);
      background:#ffffff;
      color:var(--text-main);
      outline:none;
      min-height:2rem;
    }
    .field input::placeholder,
    .field textarea::placeholder{color:#9ca3af;}
    .field textarea{resize:vertical;min-height:2.4rem;max-height:5.5rem;}
    .field input:focus,
    .field select:focus,
    .field textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(31,122,203,0.55);
    }
    .field input[disabled],
    .field select[disabled],
    .field textarea[disabled]{
      background:#f9fafb;
      color:#9ca3af;
      cursor:not-allowed;
    }
    .field-inline{display:flex;align-items:center;gap:0.4rem;}
    .field-inline select,
    .field-inline input{flex:1;}
    .btn-add-option,
    .btn-manage-option{
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#f9fafb;
      padding:0.25rem 0.55rem;
      font-size:0.8rem;
      cursor:pointer;
      color:#374151;
    }
    .btn-add-option:hover,
    .btn-manage-option:hover{background:#e5e7eb;}
    .form-actions{
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      justify-content:flex-end;
      margin-top:0.8rem;
    }
    .btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.35rem;
      padding:0.4rem 0.85rem;
      border-radius:999px;
      border:1px solid transparent;
      background:#e5e7eb;
      color:#111827;
      font-size:0.8rem;
      font-weight:500;
      cursor:pointer;
      transition:background 0.15s ease,color 0.15s ease,box-shadow 0.15s ease,transform 0.08s ease;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(to right,var(--accent),var(--accent-strong));
      color:#f9fafb;
      border-color:transparent;
      box-shadow:0 8px 18px rgba(15,23,42,0.2);
    }
    .btn-secondary{background:#f3f4f6;color:#111827;border-color:#d1d5db;}
    .btn-ghost{background:transparent;color:#4b5563;border-color:#d1d5db;}
    .btn-danger{background:#fde2e4;color:#9b1c1f;border-color:#f8c7cc;}
    .btn:hover{
      box-shadow:0 10px 22px rgba(15,23,42,0.12);
      transform:translateY(-1px);
    }
    .btn:active{box-shadow:none;transform:translateY(0);}
    .badge-mode{
      padding:0.18rem 0.55rem;
      border-radius:999px;
      font-size:0.7rem;
      background:#e6f4ea;
      color:#19633a;
      border:1px solid #c1e6ca;
    }
    .badge-mode.editing{
      background:#fff4d6;
      color:#92400e;
      border-color:#fcd68a;
    }
    .list-top{
      display:flex;
      flex-direction:column;
      gap:0.6rem;
      width:100%;
    }
    @media (min-width:720px){
      .list-top{
        flex-direction:row;
        justify-content:space-between;
        align-items:flex-end;
      }
    }
    .filters{display:flex;flex-wrap:wrap;gap:0.45rem;}
    .filter-group{display:flex;flex-direction:column;gap:0.2rem;min-width:160px;}
    .filter-label{font-size:0.72rem;color:var(--text-muted);}
    .filter-input{
      display:flex;
      align-items:center;
      gap:0.3rem;
      padding:0.3rem 0.5rem;
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#ffffff;
    }
    .filter-input input,
    .filter-input select{
      border:none;
      outline:none;
      font-size:0.78rem;
      background:transparent;
      width:100%;
      padding:0;
      margin:0;
    }
    .filter-input span.icon{font-size:0.9rem;color:#9ca3af;}
    .table-wrapper{
      margin-top:0.75rem;
      border-radius:0.6rem;
      border:1px solid var(--border-subtle);
      background:#f9fafb;
      overflow:hidden;
      position:relative;
    }
    .table-scroll{max-height:430px;overflow:auto;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.78rem;
      min-width:760px;
    }
    thead{position:sticky;top:0;z-index:1;}
    thead tr{
      background:linear-gradient(to right,var(--accent),var(--accent-strong));
      color:#e5e7eb;
    }
    thead th{
      font-weight:500;
      padding:0.45rem 0.5rem;
      text-align:left;
      border-bottom:1px solid rgba(15,23,42,0.35);
      position:relative;
    }
    thead th::after{
      content:"";
      position:absolute;
      inset-y:0.3rem;
      right:0;
      width:1px;
      background:rgba(148,163,184,0.45);
    }
    thead th:last-child::after{display:none;}
    tbody tr:nth-child(odd){background:#ffffff;}
    tbody tr:nth-child(even){background:#f9fafb;}
    tbody tr:hover{background:#e3f1ff;}
    tbody td{
      padding:0.4rem 0.5rem;
      border-bottom:1px solid var(--border-subtle);
      vertical-align:top;
      color:#111827;
    }
    .td-nowrap{white-space:nowrap;}
    .td-actions{
      white-space:nowrap;
      display:flex;
      flex-wrap:wrap;
      gap:0.3rem;
    }
    .btn-table{
      font-size:0.72rem;
      padding:0.22rem 0.55rem;
      border-radius:999px;
    }
    .btn-table-edit{
      background:#e3f1ff;
      color:var(--accent-strong);
      border-color:#c8ddff;
    }
    .btn-table-delete{
      background:#fde2e4;
      color:#9b1c1f;
      border-color:#f8c7cc;
    }
    .td-empty{
      text-align:center;
      font-size:0.8rem;
      color:var(--text-muted);
      padding:1rem 0.5rem;
    }
    footer.page-footer{
      margin-top:1.8rem;
      text-align:center;
      font-size:0.75rem;
      color:var(--text-muted);
    }
    footer.page-footer span.dot{
      display:inline-block;
      width:3px;
      height:3px;
      border-radius:999px;
      background:#9ca3af;
      margin:0 0.3rem;
    }
    .tabs{
      display:flex;
      justify-content:center;
      gap:0.5rem;
      flex-wrap:wrap;
      margin-bottom:0.5rem;
    }
    .tab-button{
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#f3f4f6;
      padding:0.35rem 0.95rem;
      font-size:0.8rem;
      cursor:pointer;
      color:#374151;
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
    }
    .tab-button.active{
      background:linear-gradient(to right,var(--accent),var(--accent-strong));
      color:#f9fafb;
      border-color:transparent;
      box-shadow:0 8px 18px rgba(15,23,42,0.25);
    }
    .tab-panels{width:100%;}
    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    @media (max-width:600px){
      .page-shell{
        padding:1.25rem 0.75rem 2rem;
      }
      .card{
        padding:1rem 0.85rem 0.9rem;
      }
      .card-header{
        flex-direction:column;
        align-items:flex-start;
        gap:0.35rem;
      }
      .list-top{
        gap:0.5rem;
      }
      .filters{
        flex-direction:column;
      }
      .filter-group{
        min-width:100%;
      }
      .tabs{
        gap:0.35rem;
      }
      .tab-button{
        width:100%;
        justify-content:center;
      }
      .form-actions{
        justify-content:flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header class="page-header">
      <div class="page-title">Cadastro de Colaboradores</div>
      <div class="page-subtitle">Desenvolvido por Financeiro Jailton</div>
    </header>

    <main>
      <div class="tabs">
        <button type="button" class="tab-button active" data-tab="lista">Lista de Colaboradores</button>
        <button type="button" class="tab-button" data-tab="cadastro">Formul√°rio de Cadastro</button>
      </div>

      <div class="tab-panels">
        <!-- LISTA / TABELA -->
        <section class="card tab-panel active" data-panel="lista">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">
                  Lista de Colaboradores
                </div>
                <div class="card-subtitle">Visualize, filtre, edite ou exclua colaboradores cadastrados.</div>
              </div>
              <div class="card-subtitle" id="resumoTotal"></div>
            </div>

            <div class="list-top">
              <div class="filters">
                <div class="filter-group">
                  <div class="filter-label">Filtrar por status</div>
                  <div class="filter-input">
                    <span class="icon">‚öôÔ∏è</span>
                    <select id="filtroStatus">
                      <option value="Todos">Todos</option>
                      <option value="Ativo">Ativo</option>
                      <option value="Desligado">Desligado</option>
                      <option value="Afastado">Afastado</option>
                    </select>
                  </div>
                </div>
                <div class="filter-group">
                  <div class="filter-label">Filtrar por empresa pagadora</div>
                  <div class="filter-input">
                    <span class="icon">üè¢</span>
                    <select id="filtroEmpresa">
                      <option value="Todas">Todas</option>
                      <option value="Malut Pneus">Malut Pneus</option>
                      <option value="Malut Ferragens">Malut Ferragens</option>
                    </select>
                  </div>
                </div>
                <div class="filter-group">
                  <div class="filter-label">Buscar por Nome, CPF ou Contato</div>
                  <div class="filter-input">
                    <span class="icon">üîé</span>
                    <input type="text" id="buscaTexto" placeholder="Digite parte do nome, CPF ou Contato">
                  </div>
                </div>
              </div>
            </div>

            <div class="table-wrapper">
              <div class="table-scroll">
                <table id="tabela-colaboradores">
                  <thead>
                    <tr>
                      <th>Empresa</th>
                      <th>Nome</th>
                      <th>CPF</th>
                      <th>Setor</th>
                      <th>Contato</th>
                      <th>Status</th>
                      <th>Tipo da chave Pix</th>
                      <th>Chave Pix</th>
                      <th>√öltima atualiza√ß√£o</th>
                      <th>Atualizado por</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Linhas geradas via JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- FORMUL√ÅRIO -->
        <section class="card tab-panel" data-panel="cadastro">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">
                  Formul√°rio de Cadastro
                </div>
                <div class="card-subtitle">Inclua ou edite colaboradores e seus dados padr√£o de pagamento.</div>
              </div>
              <div id="badgeModo" class="badge-mode">Modo: Novo cadastro</div>
            </div>

            <form id="form-colaborador" autocomplete="off">
              <!-- Bloco Identifica√ß√£o -->
              <div class="form-section">
                <div class="form-section-header">
                  <div class="form-section-title">Identifica√ß√£o</div>
                  <div class="form-section-caption">Dados b√°sicos do colaborador</div>
                </div>
                <div class="form-grid cols-2">
                  <div class="field">
                    <label for="empresa">
                      Empresa pagadora
                      <span class="required">*</span>
                    </label>
                    <select id="empresa" name="empresa">
                      <option value="">Selecione...</option>
                      <option>Malut Pneus</option>
                      <option>Malut Ferragens</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="nome">
                      Nome completo
                      <span class="required">*</span>
                    </label>
                    <input type="text" id="nome" name="nome" placeholder="Nome do colaborador">
                  </div>
                  <div class="field">
                    <label for="cpf">
                      CPF
                      <span class="required">*</span>
                    </label>
                    <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00">
                  </div>
                  <div class="field">
                    <label for="cargo">Cargo / Fun√ß√£o</label>
                    <input type="text" id="cargo" name="cargo" placeholder="Ex.: Assistente administrativo">
                  </div>
                  <div class="field">
                    <label for="setor">Setor</label>
                    <input type="text" id="setor" name="setor" placeholder="Ex.: Adm, Oficina, Borracharia, Comercial">
                  </div>
                  <!-- Campo Contato (opcional) -->
                  <div class="field">
                    <label for="contato">Contato</label>
                    <input type="text" id="contato" name="contato" placeholder="Ex.: (67) 9 9999-9999 ou email@dominio.com">
                  </div>
                  <div class="field">
                    <label for="dataAdmissao">Data de admiss√£o</label>
                    <input type="date" id="dataAdmissao" name="dataAdmissao">
                  </div>
                  <div class="field">
                    <label for="status">
                      Status
                      <span class="required">*</span>
                    </label>
                    <select id="status" name="status">
                      <option>Ativo</option>
                      <option>Desligado</option>
                      <option>Afastado</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="dataDesligamento">Data de desligamento</label>
                    <input type="date" id="dataDesligamento" name="dataDesligamento">
                  </div>
                </div>
              </div>

              <!-- Bloco Pagamento -->
              <div class="form-section">
                <div class="form-section-header">
                  <div class="form-section-title">Pagamento</div>
                  <div class="form-section-caption">Dados padr√£o para pagamentos via Pix ou Dinheiro</div>
                </div>
                <div class="form-grid cols-3">
                  <div class="field">
                    <label for="formaPagamento">Forma de pagamento</label>
                    <div class="field-inline">
                      <select id="formaPagamento" name="formaPagamento">
                        <option>Pix</option>
                        <option>Dinheiro</option>
                      </select>
                      <button type="button" class="btn-add-option" data-target="formaPagamento" title="Adicionar nova forma de pagamento">+</button>
                      <button type="button" class="btn-manage-option" data-target="formaPagamento" title="Editar ou remover forma selecionada">‚úé</button>
                    </div>
                  </div>
                  <div class="field">
                    <label for="tipoChavePix">
                      Tipo de chave Pix
                      <span class="required">*</span>
                    </label>
                    <select id="tipoChavePix" name="tipoChavePix">
                      <option value="">Selecione...</option>
                      <option>CPF</option>
                      <option>E-mail</option>
                      <option>Telefone</option>
                      <option>Chave aleat√≥ria</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="chavePix">
                      Chave Pix
                      <span class="required">*</span>
                    </label>
                    <input type="text" id="chavePix" name="chavePix" placeholder="Chave Pix cadastrada">
                  </div>
                  <div class="field">
                    <label for="banco">Banco</label>
                    <input type="text" id="banco" name="banco" placeholder="Opcional ‚Äì nome do banco">
                  </div>
                  <div class="field">
                    <label for="agencia">Ag√™ncia</label>
                    <input type="text" id="agencia" name="agencia" placeholder="Opcional">
                  </div>
                  <div class="field">
                    <label for="conta">Conta</label>
                    <input type="text" id="conta" name="conta" placeholder="Opcional">
                  </div>
                  <div class="field">
                    <label for="tipoConta">Tipo de conta</label>
                    <select id="tipoConta" name="tipoConta">
                      <option value="">Selecione...</option>
                      <option>Corrente</option>
                      <option>Poupan√ßa</option>
                      <option>PJ</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Bloco Controle -->
              <div class="form-section">
                <div class="form-section-header">
                  <div class="form-section-title">Controle</div>
                  <div class="form-section-caption">Hist√≥rico de atualiza√ß√£o da chave</div>
                </div>
                <div class="form-grid cols-2">
                  <div class="field">
                    <label for="dataAtualizacao">Data da √∫ltima atualiza√ß√£o da chave</label>
                    <input type="date" id="dataAtualizacao" name="dataAtualizacao">
                  </div>
                  <div class="field">
                    <label for="responsavelAtualizacao">Respons√°vel pela atualiza√ß√£o</label>
                    <input type="text" id="responsavelAtualizacao" name="responsavelAtualizacao" placeholder="Nome do ADM que atualizou">
                  </div>
                  <div class="field" style="grid-column:1 / -1;">
                    <label for="observacoes">Observa√ß√µes</label>
                    <textarea id="observacoes" name="observacoes" rows="2" placeholder="Campo livre para observa√ß√µes sobre pagamento, acordos, hist√≥rico etc."></textarea>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="button" id="btnNovo" class="btn btn-secondary">Novo</button>
                <button type="button" id="btnCancelar" class="btn btn-ghost">Cancelar</button>
                <button type="submit" id="btnSalvar" class="btn btn-primary">Salvar</button>
              </div>
            </form>
          </div>
        </section>
      </div>
    </main>

    <footer class="page-footer">
      Desenvolvido por Financeiro Jailton<span class="dot"></span>2025
    </footer>
  </div>

  <script type="module">
    // Import SDKs Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDGfwKBCWVnprgd-WkZqaNsHy1jl91LG4o",
      authDomain: "cadastro-de-colaborador.firebaseapp.com",
      projectId: "cadastro-de-colaborador",
      storageBucket: "cadastro-de-colaborador.firebasestorage.app",
      messagingSenderId: "1002016166104",
      appId: "1:1002016166104:web:4c98ac488dbfdd3a93c7ad"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colaboradoresCollection = collection(db, "colaboradores");

    (async function(){
      let colaboradores=[];        // cache em mem√≥ria, fonte de verdade = Firestore
      let editingIndex=null;
      let currentStatusFilter="Todos";
      let currentEmpresaFilter="Todas";
      let currentSearchTerm="";

      const form=document.getElementById("form-colaborador");
      const campos={
        empresa:document.getElementById("empresa"),
        nome:document.getElementById("nome"),
        cpf:document.getElementById("cpf"),
        cargo:document.getElementById("cargo"),
        setor:document.getElementById("setor"),
        contato:document.getElementById("contato"),
        dataAdmissao:document.getElementById("dataAdmissao"),
        status:document.getElementById("status"),
        dataDesligamento:document.getElementById("dataDesligamento"),
        formaPagamento:document.getElementById("formaPagamento"),
        tipoChavePix:document.getElementById("tipoChavePix"),
        chavePix:document.getElementById("chavePix"),
        banco:document.getElementById("banco"),
        agencia:document.getElementById("agencia"),
        conta:document.getElementById("conta"),
        tipoConta:document.getElementById("tipoConta"),
        dataAtualizacao:document.getElementById("dataAtualizacao"),
        responsavelAtualizacao:document.getElementById("responsavelAtualizacao"),
        observacoes:document.getElementById("observacoes")
      };

      const badgeModo=document.getElementById("badgeModo");
      const resumoTotal=document.getElementById("resumoTotal");
      const filtroStatus=document.getElementById("filtroStatus");
      const filtroEmpresa=document.getElementById("filtroEmpresa");
      const buscaTexto=document.getElementById("buscaTexto");
      const tabelaBody=document.querySelector("#tabela-colaboradores tbody");
      const btnNovo=document.getElementById("btnNovo");
      const btnCancelar=document.getElementById("btnCancelar");
      const tabButtons=document.querySelectorAll(".tab-button");
      const tabPanels=document.querySelectorAll(".tab-panel");
      const btnAddFormaPagamento=document.querySelector(".btn-add-option[data-target='formaPagamento']");
      const btnManageFormaPagamento=document.querySelector(".btn-manage-option[data-target='formaPagamento']");

      function setActiveTab(tabName){
        tabButtons.forEach(function(btn){
          if(btn.dataset.tab===tabName){btn.classList.add("active");}
          else{btn.classList.remove("active");}
        });
        tabPanels.forEach(function(panel){
          if(panel.dataset.panel===tabName){panel.classList.add("active");}
          else{panel.classList.remove("active");}
        });
      }

      function atualizarBadgeModo(){
        if(editingIndex===null){
          badgeModo.textContent="Modo: Novo cadastro";
          badgeModo.classList.remove("editing");
        }else{
          const nome=colaboradores[editingIndex]&&colaboradores[editingIndex].nome?colaboradores[editingIndex].nome:"";
          badgeModo.textContent=nome?"Modo: Editando ‚Äì "+nome:"Modo: Editando registro";
          badgeModo.classList.add("editing");
        }
      }

      function ajustarCampoDesligamento(){
        if(campos.status.value==="Ativo"){
          campos.dataDesligamento.value="";
          campos.dataDesligamento.disabled=true;
        }else if(campos.status.value==="Desligado"){
          campos.dataDesligamento.disabled=false;
        }else{
          campos.dataDesligamento.disabled=false;
        }
      }

      function resetarFormulario(){
        form.reset();
        editingIndex=null;
        atualizarBadgeModo();
        campos.status.value="Ativo";
        ajustarCampoDesligamento();
      }

      function formatarCPF(valor){
        const digits=(valor||"").replace(/\D/g,"").slice(0,11);
        if(!digits)return"";
        if(digits.length<=3)return digits;
        if(digits.length<=6)return digits.slice(0,3)+"."+digits.slice(3);
        if(digits.length<=9)return digits.slice(0,3)+"."+digits.slice(3,6)+"."+digits.slice(6);
        return digits.slice(0,3)+"."+digits.slice(3,6)+"."+digits.slice(6,9)+"-"+digits.slice(9);
      }

      function formatarDataBR(valor){
        if(!valor)return"";
        const iso=/^(\d{4})-(\d{2})-(\d{2})$/.exec(valor);
        if(iso){return iso[3]+"/"+iso[2]+"/"+iso[1];}
        const br=/^(\d{2})\/(\d{2})\/(\d{4})$/.exec(valor);
        if(br){return valor;}
        return valor;
      }

      function validarFormulario(){
        if(!campos.nome.value.trim()){
          alert('Preencha o campo "Nome completo".');
          campos.nome.focus();return false;
        }
        if(!campos.cpf.value.trim()){
          alert('Preencha o campo "CPF".');
          campos.cpf.focus();return false;
        }
        if(!campos.empresa.value.trim()){
          alert('Selecione a "Empresa pagadora".');
          campos.empresa.focus();return false;
        }
        if(!campos.status.value.trim()){
          alert('Selecione o "Status".');
          campos.status.focus();return false;
        }
        if(!campos.tipoChavePix.value.trim()){
          alert('Selecione o "Tipo de chave Pix".');
          campos.tipoChavePix.focus();return false;
        }
        if(!campos.chavePix.value.trim()){
          alert('Preencha a "Chave Pix".');
          campos.chavePix.focus();return false;
        }
        if(campos.status.value==="Desligado"&&!campos.dataDesligamento.value){
          const confirma=confirm("Status est√° como 'Desligado', mas a data de desligamento est√° vazia. Deseja continuar mesmo assim?");
          if(!confirma){
            campos.dataDesligamento.focus();return false;
          }
        }
        if(editingIndex!==null){
          if(!campos.dataAtualizacao.value){
            alert('Ao editar, preencha a "Data da √∫ltima atualiza√ß√£o da chave".');
            campos.dataAtualizacao.focus();return false;
          }
          if(!campos.responsavelAtualizacao.value.trim()){
            alert('Ao editar, informe o "Respons√°vel pela atualiza√ß√£o".');
            campos.responsavelAtualizacao.focus();return false;
          }
        }
        return true;
      }

      function coletarDadosDoFormulario(){
        return{
          empresa:campos.empresa.value.trim(),
          nome:campos.nome.value.trim(),
          cpf:formatarCPF(campos.cpf.value),
          cargo:campos.cargo.value.trim(),
          setor:campos.setor.value.trim(),
          contato:(campos.contato.value||"").trim(),
          dataAdmissao:campos.dataAdmissao.value,
          status:campos.status.value,
          dataDesligamento:campos.status.value==="Ativo"?"":campos.dataDesligamento.value,
          formaPagamento:campos.formaPagamento.value,
          tipoChavePix:campos.tipoChavePix.value,
          chavePix:campos.tipoChavePix.value==="CPF"?formatarCPF(campos.chavePix.value):campos.chavePix.value.trim(),
          banco:campos.banco.value.trim(),
          agencia:campos.agencia.value.trim(),
          conta:campos.conta.value.trim(),
          tipoConta:campos.tipoConta.value,
          dataAtualizacao:campos.dataAtualizacao.value,
          responsavelAtualizacao:campos.responsavelAtualizacao.value.trim(),
          observacoes:campos.observacoes.value.trim()
        };
      }

      function preencherFormulario(colaborador){
        campos.empresa.value=colaborador.empresa||"";
        campos.nome.value=colaborador.nome||"";
        campos.cpf.value=colaborador.cpf||"";
        campos.cargo.value=colaborador.cargo||"";
        campos.setor.value=colaborador.setor||"";
        campos.contato.value=colaborador.contato||"";
        campos.dataAdmissao.value=colaborador.dataAdmissao||"";
        campos.status.value=colaborador.status||"Ativo";
        campos.dataDesligamento.value=colaborador.dataDesligamento||"";
        campos.formaPagamento.value=colaborador.formaPagamento||"Pix";
        campos.tipoChavePix.value=colaborador.tipoChavePix||"";
        campos.chavePix.value=colaborador.chavePix||"";
        campos.banco.value=colaborador.banco||"";
        campos.agencia.value=colaborador.agencia||"";
        campos.conta.value=colaborador.conta||"";
        campos.tipoConta.value=colaborador.tipoConta||"";
        campos.dataAtualizacao.value=colaborador.dataAtualizacao||"";
        campos.responsavelAtualizacao.value=colaborador.responsavelAtualizacao||"";
        campos.observacoes.value=colaborador.observacoes||"";
        ajustarCampoDesligamento();
      }

      function aplicarFiltros(lista){
        return lista
          .map(function(c,index){return{data:c,index:index};})
          .filter(function(item){
            const c=item.data;
            if(currentStatusFilter!=="Todos"&&c.status!==currentStatusFilter){return false;}
            if(currentEmpresaFilter!=="Todas"&&c.empresa!==currentEmpresaFilter){return false;}
            if(currentSearchTerm){
              const rawTerm=currentSearchTerm;
              const nome=(c.nome||"").toLowerCase();
              const contato=(c.contato||"").toLowerCase();
              const cpfDigits=(c.cpf||"").replace(/\D/g,"");
              const termDigits=rawTerm.replace(/\D/g,"");
              const byName=nome.indexOf(rawTerm)!==-1;
              const byContato=contato.indexOf(rawTerm)!==-1;
              const byCpf=termDigits?cpfDigits.indexOf(termDigits)!==-1:false;
              if(!byName&&!byContato&&!byCpf){return false;}
            }
            return true;
          });
      }

      function atualizarResumoTotal(){
        const total=colaboradores.length;
        const ativos=colaboradores.filter(function(c){return c.status==="Ativo";}).length;
        if(total===0){resumoTotal.textContent="Nenhum colaborador cadastrado.";}
        else{resumoTotal.textContent=ativos+" ativos de "+total+" cadastrados.";}
      }

      function renderizarTabela(){
        tabelaBody.innerHTML="";
        const filtrados=aplicarFiltros(colaboradores);
        if(!filtrados.length){
          const tr=document.createElement("tr");
          const td=document.createElement("td");
          td.colSpan=11;
          td.className="td-empty";
          td.textContent="Nenhum colaborador encontrado com os filtros atuais.";
          tr.appendChild(td);
          tabelaBody.appendChild(tr);
          atualizarResumoTotal();
          return;
        }
        filtrados.forEach(function(item){
          const c=item.data;
          const index=item.index;
          const tr=document.createElement("tr");
          function addCell(text,extraClass){
            const td=document.createElement("td");
            if(extraClass)td.className=extraClass;
            td.textContent=text||"";
            tr.appendChild(td);
          }
          addCell(c.empresa||"");
          addCell(c.nome||"");
          addCell(c.cpf||"","td-nowrap");
          addCell(c.setor||"");
          addCell(c.contato||"");
          addCell(c.status||"");
          addCell(c.tipoChavePix||"");
          addCell(c.chavePix||"");
          addCell(formatarDataBR(c.dataAtualizacao||""),"td-nowrap");
          addCell(c.responsavelAtualizacao||"");

          const tdAcoes=document.createElement("td");
          tdAcoes.className="td-actions";

          const btnEditar=document.createElement("button");
          btnEditar.type="button";
          btnEditar.textContent="Editar";
          btnEditar.className="btn btn-table btn-table-edit";
          btnEditar.addEventListener("click",function(){iniciarEdicao(index);});

          const btnExcluir=document.createElement("button");
          btnExcluir.type="button";
          btnExcluir.textContent="Excluir";
          btnExcluir.className="btn btn-table btn-table-delete";
          btnExcluir.addEventListener("click",function(){excluirColaborador(index);});

          tdAcoes.appendChild(btnEditar);
          tdAcoes.appendChild(btnExcluir);
          tr.appendChild(tdAcoes);
          tabelaBody.appendChild(tr);
        });
        atualizarResumoTotal();
      }

      function iniciarEdicao(index){
        const colaborador=colaboradores[index];
        if(!colaborador)return;
        editingIndex=index;
        preencherFormulario(colaborador);
        atualizarBadgeModo();
        setActiveTab("cadastro");
        window.scrollTo({top:0,behavior:"smooth"});
      }

      async function excluirColaborador(index){
        const colaborador=colaboradores[index];
        if(!colaborador)return;
        const nome=colaborador.nome||"";
        const msg=nome?'Confirma a exclus√£o do colaborador "'+nome+'"?':"Confirma a exclus√£o deste colaborador?";
        if(!confirm(msg))return;

        try{
          if(!colaborador.id){
            alert("Registro sem ID do Firebase. Recarregue a p√°gina e tente novamente.");
            return;
          }
          const ref=doc(db,"colaboradores",colaborador.id);
          await deleteDoc(ref);
          colaboradores.splice(index,1);
          renderizarTabela();
          if(editingIndex===index){
            resetarFormulario();
          }else if(editingIndex!==null&&index<editingIndex){
            editingIndex=editingIndex-1;
            atualizarBadgeModo();
          }
        }catch(error){
          console.error("Erro ao excluir colaborador:",error);
          alert("N√£o foi poss√≠vel excluir o colaborador no Firebase.");
        }
      }

      async function salvarColaborador(event){
        event.preventDefault();
        if(!validarFormulario())return;
        const dados=coletarDadosDoFormulario();

        try{
          if(editingIndex===null){
            // Novo registro
            const docRef=await addDoc(colaboradoresCollection,dados);
            colaboradores.push({ id:docRef.id, ...dados });
          }else{
            // Edi√ß√£o
            const atual=colaboradores[editingIndex];
            if(!atual || !atual.id){
              alert("Registro sem ID do Firebase. Recarregue a p√°gina e tente novamente.");
              return;
            }
            const ref=doc(db,"colaboradores",atual.id);
            await updateDoc(ref,dados);
            colaboradores[editingIndex]={ id:atual.id, ...dados };
          }
          renderizarTabela();
          resetarFormulario();
          setActiveTab("lista");
          alert("Registro salvo com sucesso.");
        }catch(error){
          console.error("Erro ao salvar colaborador:",error);
          alert("N√£o foi poss√≠vel salvar o registro no Firebase.");
        }
      }

      async function carregarDoFirestore(){
        colaboradores=[];
        try{
          const snapshot=await getDocs(colaboradoresCollection);
          snapshot.forEach(function(docSnap){
            const data=docSnap.data()||{};
            colaboradores.push({
              id:docSnap.id,
              ...data
            });
          });
        }catch(error){
          console.error("Erro ao carregar dados do Firebase:",error);
          alert("N√£o foi poss√≠vel carregar os dados do Firebase.");
        }
      }

      function configurarEventos(){
        campos.status.addEventListener("change",ajustarCampoDesligamento);
        form.addEventListener("submit",salvarColaborador);

        btnNovo.addEventListener("click",function(){
          resetarFormulario();
          setActiveTab("cadastro");
        });

        btnCancelar.addEventListener("click",function(){
          if(editingIndex!==null){
            const confirma=confirm("Voc√™ est√° editando um registro. Deseja descartar as altera√ß√µes?");
            if(!confirma)return;
          }
          resetarFormulario();
        });

        filtroStatus.addEventListener("change",function(){
          currentStatusFilter=filtroStatus.value;
          renderizarTabela();
        });

        filtroEmpresa.addEventListener("change",function(){
          currentEmpresaFilter=filtroEmpresa.value;
          renderizarTabela();
        });

        buscaTexto.addEventListener("input",function(){
          currentSearchTerm=buscaTexto.value.toLowerCase().trim();
          renderizarTabela();
        });

        tabButtons.forEach(function(btn){
          btn.addEventListener("click",function(){
            const tab=btn.dataset.tab;
            setActiveTab(tab);
          });
        });

        campos.cpf.addEventListener("input",function(){
          campos.cpf.value=formatarCPF(campos.cpf.value);
        });

        campos.chavePix.addEventListener("input",function(){
          if(campos.tipoChavePix.value==="CPF"){
            campos.chavePix.value=formatarCPF(campos.chavePix.value);
          }
        });

        campos.tipoChavePix.addEventListener("change",function(){
          if(campos.tipoChavePix.value==="CPF"){
            campos.chavePix.value=formatarCPF(campos.chavePix.value);
          }
        });

        if(btnAddFormaPagamento){
          btnAddFormaPagamento.addEventListener("click",function(){
            const novo=prompt("Informe a nova forma de pagamento:");
            const valor=(novo||"").trim();
            if(!valor)return;
            const select=campos.formaPagamento;
            const jaExiste=Array.prototype.some.call(select.options,function(opt){
              return opt.value.toLowerCase()===valor.toLowerCase();
            });
            if(!jaExiste){
              const opt=document.createElement("option");
              opt.value=valor;
              opt.textContent=valor;
              select.appendChild(opt);
            }
            select.value=valor;
          });
        }

        if(btnManageFormaPagamento){
          btnManageFormaPagamento.addEventListener("click",function(){
            const select=campos.formaPagamento;
            const atual=select.value;
            if(atual==="Pix"||atual==="Dinheiro"){
              alert("S√≥ √© poss√≠vel editar ou remover formas personalizadas.");
              return;
            }
            const novo=prompt('Edite o nome da forma de pagamento ou deixe em branco para remover:',atual);
            if(novo===null)return;
            const texto=(novo||"").trim();
            if(!texto){
              const idx=select.selectedIndex;
              if(idx>-1){select.remove(idx);}
              select.value="Pix";
              return;
            }
            const opt=select.options[select.selectedIndex];
            opt.value=texto;
            opt.textContent=texto;
            select.value=texto;
          });
        }
      }

      // Inicializa√ß√£o
      configurarEventos();
      ajustarCampoDesligamento();
      atualizarBadgeModo();
      setActiveTab("lista");
      await carregarDoFirestore();
      renderizarTabela();
    })();
  </script>
</body>
</html>
